import requests
import execjs
import re
import json
from random import choice
from distance import SlideCrack

points = [
    "[[1116,1974,50],[1117,1974,52],[1118,1974,56],[1120,1974,58],[1123,1975,60],[1124,1975,63],[1127,1975,66],[1132,1975,68],[1134,1975,71],[1149,1977,75],[1151,1977,80],[1160,1977,84],[1177,1979,89],[1188,1980,93],[1207,1982,97],[1214,1983,102],[1220,1983,104],[1225,1984,106],[1230,1985,108],[1236,1985,110],[1239,1985,112],[1243,1986,114],[1247,1987,117],[1251,1987,119],[1256,1988,123],[1257,1989,128],[1259,1989,130],[1260,1989,133],[1261,1989,135],[1262,1989,139],[1261,1989,268],[1260,1989,326],[1259,1989,401],[1260,1989,608],[1261,1989,647],[1262,1989,667],[1263,1989,678],[1263,1988,694],[1264,1988,695],[1265,1988,707],[1266,1988,722],[1267,1988,730],[1268,1988,805],[1268,1987,1246]]",
    "[[1118,1981,24],[1120,1981,27],[1122,1981,33],[1125,1981,38],[1127,1981,42],[1129,1981,44],[1132,1980,51],[1135,1980,54],[1137,1980,58],[1138,1979,62],[1140,1979,63],[1143,1979,69],[1145,1979,73],[1147,1979,77],[1149,1979,82],[1151,1979,87],[1153,1979,92],[1155,1979,97],[1157,1979,106],[1159,1979,114],[1161,1979,124],[1162,1980,129],[1164,1980,148],[1166,1980,160],[1168,1980,171],[1169,1981,173],[1171,1981,181],[1173,1981,188],[1175,1982,193],[1177,1982,196],[1179,1982,201],[1181,1982,207],[1183,1982,211],[1185,1982,219],[1187,1982,235],[1189,1982,248],[1191,1982,255],[1193,1982,265],[1195,1982,275],[1197,1982,287],[1199,1982,295],[1201,1982,302],[1203,1982,307],[1205,1982,315],[1207,1982,319],[1209,1981,326],[1211,1981,331],[1213,1981,341],[1215,1981,351],[1216,1980,356],[1218,1980,378],[1220,1980,411]]",
    "[[1120,1975,2],[1121,1975,4],[1124,1975,18],[1127,1975,28],[1131,1975,38],[1134,1975,43],[1138,1975,49],[1145,1975,55],[1153,1975,60],[1159,1976,64],[1167,1976,69],[1178,1976,76],[1185,1977,80],[1192,1977,86],[1199,1977,92],[1203,1977,96],[1206,1977,101],[1211,1977,108],[1216,1977,117],[1220,1977,122],[1223,1977,129],[1226,1977,135],[1230,1977,141],[1233,1977,146],[1236,1977,152],[1241,1977,160],[1244,1977,164],[1248,1978,171],[1251,1978,175],[1254,1978,179],[1258,1979,185],[1261,1980,189],[1265,1980,196],[1268,1981,202],[1272,1981,209],[1275,1981,218],[1277,1982,226],[1280,1982,241],[1282,1983,248],[1286,1983,257],[1290,1984,266],[1294,1985,272],[1297,1985,276],[1300,1986,280],[1304,1987,286],[1309,1988,293],[1312,1988,297],[1315,1989,302],[1318,1990,308],[1322,1990,318],[1325,1991,335],[1324,1991,621],[1322,1990,640],[1320,1989,648],[1317,1988,663],[1314,1988,674],[1311,1987,685],[1309,1986,692],[1307,1985,704],[1305,1984,717]]",
    "[[1106,1975,2],[1107,1975,6],[1110,1975,16],[1113,1975,25],[1117,1976,33],[1120,1976,39],[1123,1976,45],[1126,1977,50],[1130,1978,57],[1134,1978,61],[1138,1978,70],[1142,1979,74],[1145,1979,79],[1149,1979,84],[1153,1980,90],[1156,1980,94],[1159,1980,98],[1164,1980,105],[1170,1982,110],[1174,1982,115],[1181,1983,122],[1186,1984,126],[1190,1985,131],[1196,1985,136],[1201,1986,142],[1203,1987,146],[1209,1987,153],[1213,1987,157],[1216,1987,162],[1220,1987,171],[1223,1988,175],[1227,1988,183],[1230,1988,194],[1232,1989,203],[1235,1989,210],[1238,1989,219],[1240,1990,224],[1244,1990,233],[1247,1990,240],[1251,1991,250],[1254,1991,256],[1257,1991,266],[1259,1992,273],[1262,1993,283],[1265,1993,292],[1268,1993,305],[1270,1994,345],[1273,1994,493],[1275,1995,510],[1278,1995,531],[1281,1995,547],[1283,1996,557],[1286,1996,566],[1289,1996,575],[1291,1997,583],[1294,1997,612],[1296,1998,632],[1299,1998,744],[1302,1998,929],[1305,1998,1130],[1308,1998,1256],[1311,1999,1271],[1314,2000,1285],[1314,2000,1605]]",
    "[[1125,1965,63],[1126,1965,69],[1129,1965,78],[1133,1965,85],[1136,1965,89],[1139,1966,94],[1143,1967,100],[1147,1967,104],[1150,1967,108],[1155,1968,115],[1158,1968,120],[1161,1968,124],[1164,1969,129],[1167,1970,135],[1170,1970,140],[1174,1970,149],[1176,1971,151],[1179,1971,158],[1183,1972,168],[1186,1972,175],[1189,1972,187],[1191,1973,207],[1193,1974,224],[1195,1975,247],[1198,1975,270],[1200,1976,287],[1203,1976,312],[1205,1977,329],[1207,1978,348],[1210,1978,370],[1212,1979,388],[1215,1979,430],[1217,1980,681],[1220,1980,819],[1222,1981,892],[1225,1981,912],[1228,1982,932],[1231,1983,942],[1234,1983,949],[1236,1984,953],[1239,1984,962],[1242,1985,968],[1245,1986,979],[1247,1987,985],[1250,1987,995],[1252,1988,1006],[1255,1988,1022],[1258,1989,1036],[1261,1989,1051],[1264,1989,1061],[1266,1990,1068],[1268,1991,1074],[1271,1991,1087],[1274,1991,1100],[1277,1991,1111],[1280,1991,1120],[1283,1991,1132],[1286,1991,1145],[1289,1991,1161],[1292,1991,1181],[1295,1991,1262],[1298,1991,1307],[1301,1991,1599],[1304,1991,1652],[1307,1991,1667],[1310,1991,1680],[1313,1992,1715]]",
]


def get_js_function(js_path, func_name, func_arg, func_arg1, func_arg2):
    with open(js_path, encoding="utf-8") as fp:
        js = fp.read()
        ctx = execjs.compile(js)
        return ctx.call(func_name, func_arg, func_arg1, func_arg2)


def get_token():
    headers = {
        "Host": "captcha.yunpian.com",
        "Referer": "https://www.yunpian.com/product/captcha",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.113 Safari/537.36",
    }

    params = get_js_function(r"yp.js", "gettoken", "", "", "")
    res = requests.get(
        url="https://captcha.yunpian.com//v1/jsonp/captcha/get?", headers=headers, params=params
    )
    print(res.text)
    data = re.findall("ypjsonp\((.*?)\)", res.text)[0]
    data = json.loads(data)
    bg = data.get("data").get("bg")
    with open("bg.png", "wb") as f:
        content = requests.get(url=bg).content
        f.write(content)
    front = data.get("data").get("front")
    with open("front.png", "wb") as f:
        content = requests.get(url=front).content
        f.write(content)
    token = data.get("data").get("token")
    return token


def get_distance():
    # 滑块图片
    image1 = "front.png"
    # 背景图片
    image2 = "bg.png"
    # 处理结果图片,用红线标注
    image3 = "res.png"
    sc = SlideCrack(image1, image2, image3)
    return sc.discern()


def get_res(x, token):
    headers = {
        "Host": "captcha.yunpian.com",
        "Referer": "https://www.yunpian.com/product/captcha",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.113 Safari/537.36",
    }
    point = choice(points)
    # print(point)
    params = get_js_function(r"yp.js", "getres", point, str(x), token)
    # print(params)
    res = requests.get(
        url="https://captcha.yunpian.com/v1/jsonp/captcha/verify?", params=params, headers=headers
    )
    print("-" * 20)
    print(res.text)


if __name__ == "__main__":
    token = get_token()
    x = get_distance()
    get_res(x, token)
